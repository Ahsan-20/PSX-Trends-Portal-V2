<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PSX Trends Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .columns-panel { transition: transform 0.3s ease-in-out; }
    .backdrop { background-color: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 relative min-h-screen">

  <!-- Gradient Header -->
  <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg fixed w-full z-30">
    <div class="container mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
      <div class="flex items-center">
        <h1 class="text-3xl font-extrabold">PSX Trends Portal</h1>
        {% if report_date %}
          <span class="ml-4 text-sm opacity-75">{{ report_date }}</span>
        {% endif %}
      </div>
      <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
        <!-- Export CSV -->
        <button id="exportCsv" class="flex items-center gap-2 px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg font-medium shadow-sm transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8m0 0l-3-3m3 3l3-3M8 7l4-4 4 4" />
          </svg>
          <span>Export CSV</span>
        </button>
        <!-- Columns Toggle -->
        <button id="columnsToggle" class="flex items-center gap-2 px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg font-medium shadow-sm transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <span>Columns</span>
        </button>
        <!-- Search Bar -->
        <div class="relative flex-1 min-w-[200px]">
          <input id="searchInput" type="text" placeholder="Search Symbol, Sector, or Company"
                 class="w-full pl-12 pr-12 py-2 bg-white text-gray-800 rounded-full shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-400"/>
          <span class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a7 7 0 014.9 11.9l4.2 4.2-1.4 1.4-4.2-4.2A7 7 0 1111 4z" />
            </svg>
          </span>
          <button id="clearSearch"
        onclick="document.getElementById('searchInput').value=''; document.getElementById('searchInput').focus(); applyFilters();"
        class="absolute inset-y-0 right-4 flex items-center text-gray-400 hover:text-gray-600">

            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <!-- Status Filter -->
        <select id="statusFilter"
                class="px-4 py-2 bg-white text-gray-800 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
          <option value="all">All Status</option>
          <option value="double">Double Breakouts</option>
          <option value="triple">Triple Breakouts</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Side Panel Backdrop -->
  <div id="backdrop" class="hidden fixed inset-0 backdrop z-30"></div>

  <!-- Columns Side Panel -->
  <aside id="columnsPanel" class="columns-panel fixed top-0 right-0 h-full w-72 bg-white shadow-2xl transform translate-x-full p-6 z-40 flex flex-col">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold">Select Columns</h2>
      <button id="columnsClose" class="text-gray-600 hover:text-gray-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="columnsList" class="flex-1 overflow-y-auto space-y-3">
      <!-- Dynamically generated list -->
    </div>
  </aside>

  <!-- Main Content -->
<main id="mainContent" class="container mx-auto px-6 pb-8">
  <div class="mt-6 bg-white p-4 rounded-2xl shadow-xl overflow-x-auto">
      <div class="max-h-[80vh] overflow-y-auto">
        <table id="dataTable" class="min-w-full divide-y divide-gray-200 text-center">
          <thead class="bg-purple-50 sticky top-0 z-20">
            <tr>
              {% for head in headers %}
<th data-col-index="{{ loop.index0 }}"
    class="px-6 py-5 text-lg font-semibold text-purple-800 uppercase tracking-wider">
  {{ head.replace('_',' ') }}
</th>

              {% endfor %}
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            {% set status_idxs  = [headers.index('Daily Status'), headers.index('Weekly Status'), headers.index('Monthly Status')] %}
            {% set discount_idx = headers.index('Discount') %}
            {% set ema_idxs     = [headers.index('EMA9'), headers.index('EMA21'), headers.index('EMA44'), headers.index('EMA100'), headers.index('EMA200')] %}
            {% set ratio_idx    = headers.index('Settlement_Ratio_By_Volume') %}
            {% set vol_idx      = headers.index('Total_Settlement_Volume') %}

            {% for row in rows %}
              <tr class="hover:bg-purple-50 transition">
                {% for cell in row %}
                  {% set idx = loop.index0 %}
                  <td data-col-index="{{ idx }}" class="px-6 py-5 whitespace-nowrap text-lg">
                    {% if not cell %}
                      <span class="inline-block w-full text-gray-400">----</span>
                    {% elif idx in status_idxs %}
                      {% if cell == 'Breakout' %}
                        <span class="inline-flex items-center w-full px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">▲ {{ cell }}</span>
                      {% elif cell == 'Breakdown' %}
                        <span class="inline-flex items-center w-full px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">▼ {{ cell }}</span>
                      {% else %}
                        <span class="inline-flex items-center w-full px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">• {{ cell }}</span>
                      {% endif %}
                    {% elif idx == discount_idx %}
                      {% if cell.startswith('-') %}
                        <span class="inline-block w-full text-red-600 font-semibold">{{ cell }}</span>
                      {% else %}
                        <span class="inline-block w-full text-green-600 font-semibold">{{ cell }}</span>
                      {% endif %}
                    {% elif idx in ema_idxs %}
                      {% set v = cell|lower %}
                      {% if v == 'above' %}
                        <span class="inline-block w-full px-3 py-1 bg-green-100 text-green-800 font-medium rounded-full text-sm">{{ cell }}</span>
                      {% elif v == 'below' %}
                        <span class="inline-block w-full px-3 py-1 bg-red-100 text-red-800 font-medium rounded-full text-sm">{{ cell }}</span>
                      {% elif v == 'on' %}
                        <span class="inline-block w-full px-3 py-1 bg-orange-100 text-orange-800 font-medium rounded-full text-sm">{{ cell }}</span>
                      {% else %}
                        <span class="inline-block w-full">{{ cell }}</span>
                      {% endif %}
                    {% elif idx == ratio_idx %}
                      {% set ratio_val = cell|float %}
                      {% if ratio_val < 40 %}
                        <span class="inline-block w-full px-3 py-1 bg-red-100 text-red-800 font-medium rounded-full text-sm">{{ cell }}%</span>
                      {% elif ratio_val < 60 %}
                        <span class="inline-block w-full px-3 py-1 bg-orange-100 text-orange-800 font-medium rounded-full text-sm">{{ cell }}%</span>
                      {% elif ratio_val < 80 %}
                        <span class="inline-block w-full px-3 py-1 bg-blue-100 text-blue-800 font-medium rounded-full text-sm">{{ cell }}%</span>
                      {% else %}
                        <span class="inline-block w-full px-3 py-1 bg-green-100 text-green-800 font-medium rounded-full text-sm">{{ cell }}%</span>
                      {% endif %}
                    {% elif idx == vol_idx %}
                      <span class="inline-block w-full">{{ "{:,}".format(cell|int) }}</span>
                    {% else %}
                      <span class="inline-block w-full">{{ cell }}</span>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t py-4 text-center mt-12">
    <div class="container mx-auto text-sm text-gray-500">&copy; 2025 PSX Monitor</div>
  </footer>

  <script>
    function updateMainOffset() {
      const header = document.querySelector('header');
      const main   = document.getElementById('mainContent');
      if (header && main) {
        main.style.paddingTop = header.offsetHeight + 'px';
      }
    }
    window.addEventListener('DOMContentLoaded', updateMainOffset);
    window.addEventListener('resize', updateMainOffset);
    // CSV export
    document.getElementById('exportCsv').addEventListener('click', () => {
      const visible = Array.from(document.querySelectorAll('#dataTable thead th[data-col-index]'))
        .filter(th => !th.classList.contains('hidden'))
        .map(th => th.getAttribute('data-col-index'));
      const headersCsv = visible.map(i =>
        document.querySelector(`#dataTable thead th[data-col-index="${i}"]`).innerText.trim()
      );
      const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'))
        .filter(tr => tr.style.display !== 'none');
      const lines = [ headersCsv.join(',') ];
      rows.forEach(tr => {
        const row = visible.map(i => {
          const td = tr.querySelector(`td[data-col-index="${i}"]`);
          return `"${(td && td.innerText.trim())||''}"`;
        });
        lines.push(row.join(','));
      });
      const blob = new Blob([lines.join('\n')], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'psx_trends.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // Columns panel logic
    const toggle = document.getElementById('columnsToggle'),
          panel  = document.getElementById('columnsPanel'),
          closeBtn = document.getElementById('columnsClose'),
          backdrop = document.getElementById('backdrop'),
          ths    = document.querySelectorAll('#dataTable thead th[data-col-index]'),
          list   = document.getElementById('columnsList');

    function openPanel() {
      panel.classList.remove('translate-x-full');
      backdrop.classList.remove('hidden');
    }
    function closePanel() {
      panel.classList.add('translate-x-full');
      backdrop.classList.add('hidden');
    }

    toggle.addEventListener('click', openPanel);
    closeBtn.addEventListener('click', closePanel);
    backdrop.addEventListener('click', closePanel);

    ths.forEach(th => {
      const idx = th.getAttribute('data-col-index'),
            label = th.innerText,
            div = document.createElement('div');
      div.innerHTML = `
        <label class="inline-flex items-center">
          <input type="checkbox" data-col="${idx}" checked class="form-checkbox h-4 w-4"/>
          <span class="ml-2 text-gray-700">${label}</span>
        </label>`;
      list.appendChild(div);
    });

    list.addEventListener('change', e => {
      if (!e.target.matches('input[type=checkbox]')) return;
      const idx = e.target.getAttribute('data-col'),
            show = e.target.checked;
      document.querySelector(`#dataTable thead th[data-col-index=\"${idx}\"]`)
              .classList.toggle('hidden', !show);
      document.querySelectorAll(`#dataTable tbody td[data-col-index=\"${idx}\"]`)
              .forEach(td => td.classList.toggle('hidden', !show));
    });

    // Search & breakout filter logic
    const statusFilter  = document.getElementById('statusFilter'),

          searchInput    = document.getElementById('searchInput'),
          statusIdxs     = [{{ status_idxs|join(',') }}],
          symbolIdx      = {{ headers.index('Symbol') }},
          sectorIdx      = {{ headers.index('Sector') }},
          companyIdx     = {{ headers.index('Company') }};

    function applyFilters() {
      const mode = statusFilter.value,

            term = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('#dataTable tbody tr').forEach(tr => {
        const tds   = tr.querySelectorAll('td'),
              count = statusIdxs.reduce((c,i) =>
                c + (tds[i].innerText.includes('Breakout')?1:0), 0),
              hay   = [symbolIdx, sectorIdx, companyIdx]
                      .map(i => tds[i].innerText.toLowerCase()).join(' '),
              textMatch = hay.includes(term),
              breakoutMatch = mode==='all' ||
                (mode==='double'?count===2:(mode==='triple'?count===3:false));
        tr.style.display = (textMatch && breakoutMatch)?'' : 'none';
      });
    }
    statusFilter.addEventListener('change', applyFilters);

    searchInput.addEventListener('input', applyFilters);
  </script>
</body>
</html>
